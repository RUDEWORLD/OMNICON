{% extends "base.html" %}

{% block title %}Dashboard - Omnicon Control Panel{% endblock %}

{% block content %}
<div class="row">
    <!-- System Status Card -->
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> System Status</h5>
            </div>
            <div class="card-body">
                <div id="systemInfo">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Control Card -->
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-exchange-alt"></i> Service Control</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <button class="btn btn-outline-primary w-100" id="companionBtn" onclick="toggleService('companion')">
                            <i class="fas fa-satellite-dish"></i><br>
                            Companion
                            <div id="companionStatus" class="mt-1">
                                <small class="badge bg-secondary">Checking...</small>
                            </div>
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-primary w-100" id="satelliteBtn" onclick="toggleService('satellite')">
                            <i class="fas fa-satellite"></i><br>
                            Satellite
                            <div id="satelliteStatus" class="mt-1">
                                <small class="badge bg-secondary">Checking...</small>
                            </div>
                        </button>
                    </div>
                </div>
                <button class="btn btn-info w-100 mt-3" id="openGuiBtn" onclick="openActiveServiceGui()" style="display: none;">
                    <i class="fas fa-external-link-alt"></i> <span id="openGuiBtnText">Open GUI</span>
                </button>
                <div class="alert alert-secondary mt-3 mb-0" id="noServiceAlert">
                    <small><i class="fas fa-info-circle"></i> Click above to activate a service</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Network Settings Card -->
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-network-wired"></i> Network Settings</h5>
            </div>
            <div class="card-body">
                <div id="networkInfo" class="mb-3">
                    <div class="text-center">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="networkMode" id="dhcpMode" autocomplete="off">
                    <label class="btn btn-outline-primary" for="dhcpMode" onclick="setNetworkMode('DHCP')">
                        <i class="fas fa-magic"></i> DHCP
                    </label>

                    <input type="radio" class="btn-check" name="networkMode" id="staticMode" autocomplete="off">
                    <label class="btn btn-outline-primary" for="staticMode" onclick="showStaticConfig()">
                        <i class="fas fa-wrench"></i> Static IP
                    </label>
                </div>

                <!-- WiFi Section -->
                <hr class="my-3">
                <h6 class="mb-3"><i class="fas fa-wifi"></i> WiFi Settings</h6>

                <div id="wifiStatus" class="mb-3">
                    <table class="network-info-table">
                        <tr>
                            <td>Status:</td>
                            <td><span id="wifiStatusBadge" class="badge bg-secondary">Checking...</span></td>
                        </tr>
                        <tr id="wifiSsidRow" style="display: none;">
                            <td>Network:</td>
                            <td><strong id="wifiSsid">--</strong> <span id="wifiSignal" class="text-muted"></span></td>
                        </tr>
                        <tr id="wifiIpRow" style="display: none;">
                            <td>WiFi IP:</td>
                            <td><strong id="wifiIp">--</strong></td>
                        </tr>
                    </table>
                </div>

                <div class="btn-group w-100" role="group">
                    <button class="btn btn-outline-danger" onclick="disconnectWifi()" id="wifiDisconnectBtn">
                        <i class="fas fa-times"></i> Disconnect
                    </button>
                    <button class="btn btn-outline-success" onclick="showWifiConnect()" id="wifiConnectBtn">
                        <i class="fas fa-wifi"></i> Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Updates Card -->
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-download"></i> Updates</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-success" onclick="showOmniconUpdate()">
                        <i class="fas fa-microchip"></i> Update Omnicon
                    </button>
                    <div class="mt-2 text-center">
                        <small class="text-muted">
                            Current: <span id="currentOmniconVersion">--</span><br>
                            Available: <span id="availableOmniconVersion">--</span>
                        </small>
                    </div>

                    <!-- Companion and Satellite Updates -->
                    <div class="mt-3 pt-3 border-top text-center">
                        <button class="btn btn-outline-info" onclick="showCompanionUpdate()">
                            <i class="fas fa-satellite-dish"></i> Update Companion
                        </button>
                        <button class="btn btn-outline-warning ms-2" onclick="showSatelliteUpdate()">
                            <i class="fas fa-satellite"></i> Update Satellite
                        </button>
                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                Companion: <span id="companionVersion">--</span> |
                                Satellite: <span id="satelliteVersion">--</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Date/Time Settings Card -->
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Date & Time</h5>
            </div>
            <div class="card-body">
                <div id="dateTimeInfo" class="mb-3">
                    <p class="mb-1"><strong>Current Date:</strong> <span id="currentDate">--</span></p>
                    <p class="mb-1"><strong>Current Time:</strong> <span id="currentTime">--</span></p>
                    <p class="mb-3">
                        <strong>Timezone:</strong>
                        <span id="currentTimezone">--</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="loadDateTime()" title="Refresh timezone">
                            <i class="fas fa-sync"></i>
                        </button>
                    </p>
                </div>

                <div class="d-grid gap-2">
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-secondary w-100" onclick="showDateTimeConfig()">
                                <i class="fas fa-calendar-alt"></i> Set Date/Time
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-success w-100" onclick="syncNTP()">
                                <i class="fas fa-cloud-download-alt"></i> Sync NTP
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="showTimezoneConfig()">
                        <i class="fas fa-globe"></i> Change Timezone
                    </button>
                    <div class="btn-group w-100 mt-2" role="group">
                        <button class="btn btn-outline-warning" onclick="syncRTC()">
                            <i class="fas fa-sync"></i> Set RTC
                        </button>
                        <button class="btn btn-outline-primary" onclick="checkRTC()">
                            <i class="fas fa-clock"></i> Check RTC
                        </button>
                    </div>
                    <div id="rtcStatus" class="mt-2 text-center" style="display: none;">
                        <small class="text-muted">RTC Time: <span id="rtcTime">--</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Power Control Card -->
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-power-off"></i> Power Control</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-warning" onclick="confirmPowerAction('reboot')">
                        <i class="fas fa-redo"></i> Reboot System
                    </button>
                    <button class="btn btn-danger" onclick="confirmPowerAction('shutdown')">
                        <i class="fas fa-power-off"></i> Shutdown System
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Static IP Configuration Modal -->
<div class="modal fade" id="staticConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Static IP</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="staticConfigForm">
                    <div class="mb-3">
                        <label for="staticIp" class="form-label">IP Address</label>
                        <input type="text" class="form-control" id="staticIp" placeholder="192.168.0.100" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                    </div>
                    <div class="mb-3">
                        <label for="staticSubnet" class="form-label">Subnet Mask</label>
                        <input type="text" class="form-control" id="staticSubnet" placeholder="255.255.255.0" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                    </div>
                    <div class="mb-3">
                        <label for="staticGateway" class="form-label">Gateway</label>
                        <input type="text" class="form-control" id="staticGateway" placeholder="192.168.0.1" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                    </div>
                    <div class="mb-3">
                        <label for="staticDns" class="form-label">DNS Server <small class="text-muted">(optional - defaults to gateway)</small></label>
                        <input type="text" class="form-control" id="staticDns" placeholder="Leave blank to use gateway" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStaticConfig()">Apply Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Timezone Configuration Modal -->
<div class="modal fade" id="timezoneModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Timezone</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="timezoneSearch" class="form-label">Search Timezone</label>
                    <input type="text" class="form-control" id="timezoneSearch"
                           placeholder="Type to search (e.g., New York, London, Tokyo)">
                </div>
                <div class="mb-3">
                    <label for="timezoneSelect" class="form-label">Select Timezone</label>
                    <select class="form-control" id="timezoneSelect" size="10" style="height: 300px;">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle"></i> Current timezone: <strong id="modalCurrentTz">--</strong></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTimezone()">Apply Timezone</button>
            </div>
        </div>
    </div>
</div>

<!-- Date/Time Configuration Modal -->
<div class="modal fade" id="dateTimeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Date & Time</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="dateTimeForm">
                    <div class="mb-3">
                        <label for="setDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="setDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="setTime" class="form-label">Time</label>
                        <input type="time" class="form-control" id="setTime" step="1" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="format24hr">
                            <label class="form-check-label" for="format24hr">
                                Use 24-hour format
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDateTime()">Apply Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Omnicon Update Modal -->
<div class="modal fade" id="omniconUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Omnicon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="updateCheckStatus" class="mb-3">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Checking for updates...</span>
                        </div>
                        <p class="mt-2">Checking for updates...</p>
                    </div>
                </div>
                <div id="updateVersionInfo" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Current Version:</strong> <span id="modalCurrentVersion">--</span><br>
                        <strong>Latest Version:</strong> <span id="modalLatestVersion">--</span>
                    </div>
                    <div id="updateMessage" class="mb-3"></div>
                    <div id="updateVersionList" class="list-group">
                        <!-- Version list will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateButton" style="display: none;" onclick="performOmniconUpdate()">
                    <i class="fas fa-download"></i> Update Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmBody">
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmButton">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- WiFi Connect Modal -->
<div class="modal fade" id="wifiConnectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-wifi"></i> Connect to WiFi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="wifiScanStatus" class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Scanning...</span>
                    </div>
                    <p class="mt-2">Enabling WiFi and scanning for networks...</p>
                </div>
                <div id="wifiNetworkList" style="display: none;">
                    <div class="mb-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="scanWifi()">
                            <i class="fas fa-sync"></i> Rescan
                        </button>
                    </div>
                    <div class="list-group" id="wifiNetworks" style="max-height: 300px; overflow-y: auto;">
                        <!-- Network list will be populated here -->
                    </div>
                </div>
                <div id="wifiPasswordForm" style="display: none;">
                    <div class="mb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="showNetworkList()">
                            <i class="fas fa-arrow-left"></i> Back to Networks
                        </button>
                    </div>
                    <div class="alert alert-info">
                        <strong>Network:</strong> <span id="selectedSsid">--</span>
                        <span id="selectedSecurity" class="badge bg-warning ms-2">--</span>
                    </div>
                    <form id="wifiConnectForm">
                        <div class="mb-3" id="passwordField">
                            <label for="wifiPassword" class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="wifiPassword" placeholder="Enter WiFi password">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility()">
                                    <i class="fas fa-eye" id="passwordToggleIcon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="button" class="btn btn-success" onclick="connectToWifi()">
                                <i class="fas fa-plug"></i> Connect
                            </button>
                        </div>
                    </form>
                </div>
                <div id="wifiConnectingStatus" style="display: none;">
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Connecting...</span>
                        </div>
                        <p class="mt-2">Connecting to <strong id="connectingSsid">--</strong>...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">
            Message here
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh functionality
let refreshInterval = null;
let autoRefreshEnabled = true;

$(document).ready(function() {
    loadSystemInfo();
    loadNetworkSettings();
    loadDateTime();
    loadApplicationVersions();  // Load all application versions on load
    loadWifiStatus();  // Load WiFi status on load

    // Set up auto-refresh with different intervals
    if (autoRefreshEnabled) {
        // Update time every second so you can see seconds change
        setInterval(function() {
            loadDateTime();
        }, 1000); // Refresh every 1 second

        // Update system info and network less frequently
        setInterval(function() {
            loadSystemInfo();
            loadNetworkSettings();
            loadWifiStatus();  // Also refresh WiFi status
        }, 5000); // Refresh every 5 seconds

        // Check for all application versions every 30 seconds
        setInterval(function() {
            loadApplicationVersions();
        }, 30000); // Refresh every 30 seconds
    }
});
</script>
{% endblock %}